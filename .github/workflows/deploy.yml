name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  # CI: Lint & Test (æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ)
  lint:
    name: Run Lint
    uses: ./.github/workflows/lint.yml

  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  # CD: Deploy to EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [lint, test]  # Lint/TestãŒæˆåŠŸã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SATOKEN_SECRET }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 3.92.98.19 >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@3.92.98.19 << 'EOF'
          cd /home/kojan-map
          
          echo "ðŸ”„ Pulling latest code from main branch..."
          git pull origin main
          
          echo "ðŸ³ Restarting Docker containers..."
          docker compose down
          docker compose up -d --build
          
          echo "âœ… Deployment completed!"
          
          # ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèª
          docker compose ps
        EOF

    - name: Cleanup SSH
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa

  # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - æ—¢å­˜ã®slack-notify.ymlãŒã‚ã‚‹å ´åˆï¼‰
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… Deployment succeeded!"
        # Slacké€šçŸ¥ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…

    - name: Notify Failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        # Slacké€šçŸ¥ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…
