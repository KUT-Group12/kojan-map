# バックエンド全体 統合テスト項目表

**作成日**: 2026年1月21日  
**最終更新**: 2026年1月21日  
**テスト実行方法**: `./run_all_tests.sh`（backend ディレクトリから実行）

---

## 📊 統合テスト実施状況サマリー

| バックエンド | 実装済み | 実行済み | PASS | FAIL | SKIP | カバレッジ | 状態 |
|------------|---------|---------|------|------|------|----------|------|
| User（一般会員） | ❌ 0 | - | - | - | - | 0% | 🔲 未実装 |
| Admin（管理者） | ❌ 0 | - | - | - | - | 0% | 🔲 未実装 |
| Business（事業者） | ✅ 6 | ✅ 6 | 2 | 3 | 1 | 33% | ⚠️ 部分実装 |
| **合計** | **6** | **6** | **2** | **3** | **1** | **33%** | ⚠️ |

**最終実行日時**: 2026年1月21日 15:58:50

---

## 1. User バックエンド（一般会員）統合テスト

### 1.1 テスト対象機能

| カテゴリ | 機能 | API エンドポイント | 優先度 | 実装状態 |
|---------|------|-------------------|--------|---------|
| 認証 | ユーザー登録・ログイン | POST /api/auth/login | 高 | 🔲 未実装 |
| 認証 | トークン検証 | - | 高 | 🔲 未実装 |
| 投稿 | 投稿作成 | POST /api/posts | 高 | 🔲 未実装 |
| 投稿 | 投稿一覧取得 | GET /api/posts | 中 | 🔲 未実装 |
| 投稿 | 投稿詳細取得 | GET /api/posts/:id | 中 | 🔲 未実装 |
| 投稿 | いいね機能 | POST /api/posts/:id/like | 中 | 🔲 未実装 |
| 通報 | 投稿通報 | POST /api/reports | 高 | 🔲 未実装 |
| ブロック | ユーザーブロック | POST /api/users/block | 中 | 🔲 未実装 |
| お気に入り | お気に入り登録 | POST /api/favorites | 低 | 🔲 未実装 |

### 1.2 統合テスト項目一覧

#### USER-INT-001: ユーザー登録・ログインフロー
- **目的**: Google OAuth認証からJWTトークン発行までの一連の流れをテスト
- **前提条件**: 
  - データベースが初期化済み
  - Google OAuth モックが設定済み
- **テスト手順**:
  1. Google ID トークンでログインリクエスト送信
  2. ユーザーがDBに登録されることを確認
  3. JWTトークンが返却されることを確認
  4. トークンを使って認証が必要なエンドポイントにアクセス
- **期待結果**: 
  - ステータスコード: 200
  - JWTトークンが返却される
  - ユーザー情報がDBに保存される
- **実装状態**: 🔲 未実装

#### USER-INT-002: 投稿作成とDB保存
- **目的**: 投稿作成APIとDB保存処理の統合テスト
- **前提条件**: 
  - 認証済みユーザーが存在
  - 場所データが存在
- **テスト手順**:
  1. 認証トークンを使って投稿作成リクエスト送信
  2. DBから投稿データを取得
  3. 投稿内容が正しく保存されているか確認
- **期待結果**: 
  - ステータスコード: 201
  - 投稿IDが返却される
  - DBに投稿が保存される
- **実装状態**: 🔲 未実装

#### USER-INT-003: 投稿一覧取得とページネーション
- **目的**: 投稿一覧APIのページネーション機能テスト
- **前提条件**: 
  - 複数の投稿データが存在（10件以上）
- **テスト手順**:
  1. page=1, pageSize=5 でリクエスト送信
  2. 返却されたデータ件数を確認
  3. page=2 でリクエストして異なるデータが返却されることを確認
- **期待結果**: 
  - ステータスコード: 200
  - 指定したページサイズ分のデータが返却される
  - ページごとに異なるデータが返却される
- **実装状態**: 🔲 未実装

#### USER-INT-004: 通報機能とDB保存
- **目的**: 投稿・ユーザー通報APIとDB保存の統合テスト
- **前提条件**: 
  - 認証済みユーザーが存在
  - 通報対象の投稿が存在
- **テスト手順**:
  1. 認証トークンを使って通報リクエスト送信
  2. DBから通報データを取得
  3. 通報内容が正しく保存されているか確認
- **期待結果**: 
  - ステータスコード: 201
  - 通報IDが返却される
  - DBに通報が保存される
- **実装状態**: 🔲 未実装

#### USER-INT-005: ブロック機能と投稿フィルタリング
- **目的**: ユーザーブロック機能と投稿一覧でのフィルタリング動作テスト
- **前提条件**: 
  - 2人以上のユーザーが存在
  - ブロック対象ユーザーの投稿が存在
- **テスト手順**:
  1. ユーザーAがユーザーBをブロック
  2. ユーザーAで投稿一覧を取得
  3. ユーザーBの投稿が表示されないことを確認
- **期待結果**: 
  - ステータスコード: 200
  - ブロックしたユーザーの投稿が除外される
- **実装状態**: 🔲 未実装

---

## 2. Admin バックエンド（管理者）統合テスト

### 2.1 テスト対象機能

| カテゴリ | 機能 | API エンドポイント | 優先度 | 実装状態 |
|---------|------|-------------------|--------|---------|
| 認証 | 管理者ログイン | POST /admin/auth/login | 高 | 🔲 未実装 |
| ダッシュボード | 統計情報取得 | GET /admin/dashboard | 中 | 🔲 未実装 |
| ユーザー管理 | ユーザー一覧取得 | GET /admin/users | 高 | 🔲 未実装 |
| ユーザー管理 | ユーザー削除 | DELETE /admin/users/:id | 高 | 🔲 未実装 |
| 通報管理 | 通報一覧取得 | GET /admin/reports | 高 | 🔲 未実装 |
| 通報管理 | 通報処理 | PUT /admin/reports/:id | 高 | 🔲 未実装 |
| 事業者管理 | 申請一覧取得 | GET /admin/business/applications | 高 | 🔲 未実装 |
| 事業者管理 | 申請承認 | PUT /admin/business/:id/approve | 高 | 🔲 未実装 |
| 事業者管理 | 申請却下 | PUT /admin/business/:id/reject | 高 | 🔲 未実装 |
| 問い合わせ | 問い合わせ一覧 | GET /admin/contacts | 中 | 🔲 未実装 |
| 問い合わせ | 問い合わせ承認 | PUT /admin/contacts/:id/approve | 中 | 🔲 未実装 |

### 2.2 統合テスト項目一覧

#### ADMIN-INT-001: 管理者ログインフロー
- **目的**: 管理者専用の認証フローをテスト
- **前提条件**: 
  - 管理者ユーザーがDBに存在
- **テスト手順**:
  1. 管理者認証情報でログインリクエスト送信
  2. JWTトークンが返却されることを確認
  3. トークンに管理者ロールが含まれることを確認
- **期待結果**: 
  - ステータスコード: 200
  - 管理者ロール付きJWTトークンが返却される
- **実装状態**: 🔲 未実装

#### ADMIN-INT-002: 通報一覧取得とページネーション
- **目的**: 管理者が通報を取得・管理する機能のテスト
- **前提条件**: 
  - 複数の通報データが存在
- **テスト手順**:
  1. 管理者トークンで通報一覧をリクエスト
  2. ページネーションパラメータでフィルタリング
  3. 返却データの整合性を確認
- **期待結果**: 
  - ステータスコード: 200
  - 通報データが正しく返却される
- **実装状態**: 🔲 未実装

#### ADMIN-INT-003: 通報処理とステータス更新
- **目的**: 通報を「対応済み」にマークする処理のテスト
- **前提条件**: 
  - 未処理の通報が存在
- **テスト手順**:
  1. 管理者トークンで通報処理リクエスト送信
  2. DBから通報データを取得
  3. ステータスが「handled」に更新されていることを確認
- **期待結果**: 
  - ステータスコード: 200
  - 通報のステータスが更新される
- **実装状態**: 🔲 未実装

#### ADMIN-INT-004: 事業者申請承認フロー
- **目的**: 事業者申請の承認処理をテスト
- **前提条件**: 
  - 承認待ち(pending)の事業者申請が存在
- **テスト手順**:
  1. 管理者トークンで申請承認リクエスト送信
  2. DBから申請データを取得
  3. ステータスが「approved」に更新されていることを確認
  4. business_members テーブルにレコードが作成されていることを確認
- **期待結果**: 
  - ステータスコード: 200
  - 申請ステータスが更新される
  - 事業者会員が作成される
- **実装状態**: 🔲 未実装

#### ADMIN-INT-005: ユーザー削除と論理削除
- **目的**: ユーザー削除が論理削除として動作することをテスト
- **前提条件**: 
  - 削除対象の一般ユーザーが存在
- **テスト手順**:
  1. 管理者トークンでユーザー削除リクエスト送信
  2. DBからユーザーデータを取得
  3. deletedAt が設定されていることを確認
  4. ユーザーが論理削除されていることを確認
- **期待結果**: 
  - ステータスコード: 200
  - deletedAt フィールドが設定される
  - ユーザーデータは物理削除されない
- **実装状態**: 🔲 未実装

#### ADMIN-INT-006: ダッシュボード統計情報取得
- **目的**: ダッシュボードの統計データが正しく集計されることをテスト
- **前提条件**: 
  - ユーザー、投稿、通報データが存在
- **テスト手順**:
  1. 管理者トークンでダッシュボードデータをリクエスト
  2. 返却された統計値を確認
  3. DBのデータと照合
- **期待結果**: 
  - ステータスコード: 200
  - 各統計値が正確に集計されている
- **実装状態**: 🔲 未実装

---

## 3. Business バックエンド（事業者会員）統合テスト

### 3.1 テスト対象機能

| カテゴリ | 機能 | API エンドポイント | 優先度 | 実装状態 |
|---------|------|-------------------|--------|---------|
| 認証 | 事業者ログイン | POST /business/auth/login | 高 | ✅ 実装済み |
| 投稿 | 投稿作成 | POST /business/posts | 高 | ✅ 実装済み |
| 投稿 | 投稿詳細取得 | GET /business/posts/:id | 中 | ✅ 実装済み |
| 位置情報 | 位置情報保存 | POST /business/posts (with location) | 高 | ✅ 実装済み |
| 通報 | 通報作成 | POST /business/reports | 高 | ✅ 実装済み |
| 申請 | 事業者申請 | POST /business/requests | 中 | ✅ 実装済み |

### 3.2 統合テスト項目一覧

#### BIZ-INT-001 (POST-001): 投稿作成とDB保存
- **テスト関数**: `TestIntegration_POST001_CreatePost`
- **目的**: 事業者による投稿作成APIとDB保存処理の統合テスト
- **前提条件**: 
  - 認証済み事業者会員が存在
  - 場所データ(placeId=1)が存在
  - ジャンルデータが存在
- **テスト手順**:
  1. JWTトークンを含めて投稿作成リクエスト送信
  2. レスポンスからpostIdを取得
  3. DBから投稿データを取得
  4. タイトル、説明、ジャンルIDが正しく保存されているか確認
- **期待結果**: 
  - ステータスコード: 201
  - postIdが返却される
  - DBに投稿が正しく保存される
- **実装状態**: ✅ 実装済み
- **実行結果**: ❌ **FAIL** (401 Unauthorized - ER-015)
- **関連障害**: ER-015

#### BIZ-INT-002 (POST-004): 位置情報付き投稿作成
- **テスト関数**: `TestIntegration_POST004_SaveLocation`
- **目的**: 位置情報（緯度・経度）を含む投稿作成のテスト
- **前提条件**: 
  - 認証済み事業者会員が存在
  - 既存の場所データまたは新規作成
- **テスト手順**:
  1. 緯度・経度を含む投稿作成リクエスト送信
  2. place テーブルに位置情報が保存されることを確認
  3. post と place の関連が正しく設定されることを確認
- **期待結果**: 
  - ステータスコード: 201
  - place テーブルに位置情報が保存される
  - post.placeId が正しく設定される
- **実装状態**: ✅ 実装済み
- **実行結果**: ❌ **FAIL** (401 Unauthorized - ER-015)
- **関連障害**: ER-015

#### BIZ-INT-003 (REPORT-001): 通報作成とDB保存
- **テスト関数**: `TestIntegration_REPORT001_CreateReport`
- **目的**: 通報作成APIとDB保存処理の統合テスト
- **前提条件**: 
  - 認証済み事業者会員が存在
  - 通報対象の投稿が存在
- **テスト手順**:
  1. JWTトークンを含めて通報作成リクエスト送信
  2. レスポンスからreportIdを取得
  3. DBから通報データを取得
  4. 通報理由、対象投稿IDが正しく保存されているか確認
- **期待結果**: 
  - ステータスコード: 201
  - reportIdが返却される
  - DBに通報が正しく保存される
- **実装状態**: ✅ 実装済み
- **実行結果**: ❌ **FAIL** (401 Unauthorized - ER-015)
- **関連障害**: ER-015

#### BIZ-INT-004 (BIZ-001): 事業者申請作成
- **テスト関数**: `TestIntegration_BIZ001_BusinessRequest`
- **目的**: 事業者申請APIの統合テスト
- **前提条件**: 
  - 認証済みユーザーが存在
  - business_requests テーブルが存在
- **テスト手順**:
  1. 事業者申請リクエスト送信
  2. DBに申請データが保存されることを確認
  3. 初期ステータスが「pending」であることを確認
- **期待結果**: 
  - ステータスコード: 201
  - 申請IDが返却される
  - DBに申請が保存される
- **実装状態**: ✅ 実装済み
- **実行結果**: ⏭️ **SKIP** (business_requests テーブル未存在 - ER-016)
- **関連障害**: ER-016

#### BIZ-INT-005 (AUTH-001): ログインフロー完全動作
- **テスト関数**: `TestIntegration_AUTH001_LoginFlow`
- **目的**: Google OAuth認証からJWTトークン発行までの一連のフローをテスト
- **前提条件**: 
  - テスト用ユーザーと事業者会員データが存在
- **テスト手順**:
  1. モックGoogle IDトークンでログインリクエスト送信
  2. JWTトークンが返却されることを確認
  3. トークンをデコードして中身を検証
  4. トークンを使って認証が必要なエンドポイントにアクセス
- **期待結果**: 
  - ステータスコード: 200
  - 有効なJWTトークンが返却される
  - トークンにユーザーIDと事業者IDが含まれる
- **実装状態**: ✅ 実装済み
- **実行結果**: ✅ **PASS**
- **備考**: 認証ミドルウェアを使用していないため成功

#### BIZ-INT-006 (POST-002): 投稿閲覧数増加
- **テスト関数**: `TestIntegration_POST002_GetPostIncrementsViewCount`
- **目的**: 投稿詳細取得時に閲覧数が増加することをテスト
- **前提条件**: 
  - 投稿データが存在
  - 初期閲覧数が0
- **テスト手順**:
  1. 投稿作成
  2. 投稿詳細取得APIを呼び出し
  3. DBから投稿データを取得
  4. viewCountが1増加していることを確認
- **期待結果**: 
  - ステータスコード: 200
  - viewCountが1増加する
- **実装状態**: ✅ 実装済み
- **実行結果**: ✅ **PASS**
- **備考**: 認証不要エンドポイントのため成功

---

## 4. テスト実行方法

### 4.1 全バックエンドテスト一括実行

```bash
cd /Users/moe/classwork/softwareEngineering/kojan-map/backend
./run_all_tests.sh
```

**実行内容**:
1. User バックエンド単体テスト (41件)
2. Admin バックエンド単体テスト (23件)
3. Business バックエンド単体テスト (69件)
4. Business バックエンド統合テスト (6件)
   - データベース自動初期化
   - テストデータ自動投入

### 4.2 個別バックエンドテスト実行

#### User バックエンド
```bash
cd backend/user
go test ./services -v
```

#### Admin バックエンド
```bash
cd backend/admin
go test ./... -v
```

#### Business バックエンド（単体テスト）
```bash
cd backend/business
go test ./... -v
```

#### Business バックエンド（統合テスト）
```bash
cd backend/business
DATABASE_URL="root:root@tcp(localhost:3306)/kojanmap_test?parseTime=true&charset=utf8mb4&loc=Local" \
  go test -tags=integration ./internal/api -v
```

### 4.3 テスト環境セットアップ

#### 前提条件
- Docker Desktop が起動していること
- MySQLコンテナ `kojan-map-db-1` が起動していること
- テストデータベース `kojanmap_test` が作成可能であること

#### データベース初期化
```bash
# テストDBの作成
docker exec kojan-map-db-1 mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS kojanmap_test;"

# ダンプファイルからのリストア
docker exec -i kojan-map-db-1 mysql -uroot -proot kojanmap_test < kojanmap_dump.sql

# テストデータの投入
docker exec kojan-map-db-1 mysql -uroot -proot kojanmap_test -e \
  "INSERT IGNORE INTO place (placeId, numPost, latitude, longitude) VALUES (1, 0, 35.6895, 139.6917);"
```

---

## 5. 今後の実装計画

### 5.1 優先度：高（次スプリントで実装）

1. **ER-015対応**: Business統合テストの認証ミドルウェア実装
   - 影響: BIZ-INT-001, BIZ-INT-002, BIZ-INT-003 の3テストが失敗中
   - 対応方法: `setupTestRouter()` に認証ミドルウェアを追加

2. **User統合テスト実装**
   - USER-INT-001: ログインフロー
   - USER-INT-002: 投稿作成
   - USER-INT-004: 通報機能

3. **Admin統合テスト実装**
   - ADMIN-INT-001: 管理者ログイン
   - ADMIN-INT-003: 通報処理
   - ADMIN-INT-004: 事業者申請承認

### 5.2 優先度：中（2スプリント後）

1. **ER-016調査**: business_requests テーブルの必要性確認
   - 影響: BIZ-INT-004 がスキップ中
   - 調査項目: テーブル定義、Admin側との関連性

2. **User統合テスト拡充**
   - USER-INT-003: ページネーション
   - USER-INT-005: ブロック機能

3. **Admin統合テスト拡充**
   - ADMIN-INT-002: 通報一覧取得
   - ADMIN-INT-005: ユーザー削除
   - ADMIN-INT-006: ダッシュボード統計

### 5.3 優先度：低（3スプリント後）

1. パフォーマンステスト
2. 負荷テスト
3. セキュリティテスト
4. E2Eテスト（フロントエンド連携）

---

## 6. テストカバレッジ目標

| フェーズ | 単体テスト | 統合テスト | E2Eテスト | 目標時期 |
|---------|-----------|-----------|----------|---------|
| Phase 1 | 90%以上 | 50%以上 | - | 現在 ✅ |
| Phase 2 | 95%以上 | 80%以上 | 30%以上 | 2週間後 |
| Phase 3 | 95%以上 | 90%以上 | 60%以上 | 1ヶ月後 |
| Phase 4 | 95%以上 | 95%以上 | 80%以上 | 2ヶ月後 |

**現在のカバレッジ**:
- 単体テスト: **100%** (133/133 PASS)
- 統合テスト: **33%** (2/6 PASS, 3 FAIL, 1 SKIP)
- E2Eテスト: **0%** (未実装)

---

## 7. 参考資料

- [COMPREHENSIVE_TEST_REPORT.md](../COMPREHENSIVE_TEST_REPORT.md) - バックエンド全体テスト結果詳細
- [business/testDocument/list.md](../business/testDocument/list.md) - Business単体テスト項目一覧
- [business/testDocument/er.md](../business/testDocument/er.md) - Business障害処理表
- [business/testDocument/integration-tests.md](../business/testDocument/integration-tests.md) - Business統合テストドキュメント
- [admin/test_specification.md](./test_specification.md) - Admin単体テスト項目一覧
- [run_all_tests.sh](../run_all_tests.sh) - 自動テスト実行スクリプト
